{% extends 'accounting/_form_base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'libs/jquery.repeater/jquery.repeater.css' %}">
<style>
    .voucher-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-section h5 {
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .journal-line {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .journal-line:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }
    
    .line-number {
        position: absolute;
        top: -10px;
        left: 10px;
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .udf-field {
        margin-bottom: 1rem;
    }
    
    .udf-field label {
        font-weight: 600;
        color: #495057;
    }
    
    .udf-field .form-control {
        border-radius: 6px;
        border: 1px solid #ced4da;
    }
    
    .udf-field .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .totals-section {
        background: #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .total-row.balance {
        border-top: 2px solid #007bff;
        padding-top: 0.5rem;
        font-size: 1.1rem;
        color: #007bff;
    }
    
    .btn-add-line {
        background: #28a745;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        color: white;
        font-weight: 600;
    }
    
    .btn-add-line:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .btn-remove-line {
        background: #dc3545;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        color: white;
        font-size: 0.8rem;
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .btn-remove-line:hover {
        background: #c82333;
    }
    
    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .account-balance {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .account-balance.positive {
        color: #28a745;
    }
    
    .account-balance.negative {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="page-content">
<div class="container-fluid">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if breadcrumb.1 %}
                    <li class="breadcrumb-item"><a href="{{ breadcrumb.1 }}">{{ breadcrumb.0 }}</a></li>
                {% else %}
                    <li class="breadcrumb-item active">{{ breadcrumb.0 }}</li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    {% include 'accounting/vouchers/voucher_header.html' %}

    <form method="post" id="voucher-form" class="needs-validation" novalidate enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-section">
            <h5><i class="fas fa-file-alt me-2"></i>Journal Header</h5>
            {% include 'accounting/vouchers/voucher_form_header_fields.html' %}
            {% if header_udfs %}
                {% include 'accounting/vouchers/voucher_form_udfs.html' with udfs=header_udfs scope='header' %}
            {% endif %}
        </div>

        {% include 'accounting/vouchers/voucher_form_lines.html' %}

        {% if line_udfs %}
            <div class="form-section">
                <h5>Line UDFs</h5>
                {% include 'accounting/vouchers/voucher_form_udfs.html' with udfs=line_udfs scope='line' %}
            </div>
        {% endif %}

        {% include 'accounting/vouchers/voucher_form_totals.html' %}
        {% include 'accounting/vouchers/voucher_form_attachments.html' %}
        {% include 'accounting/vouchers/voucher_form_actions.html' %}
    </form>

    <div id="voucher-preview-modal" style="display:none;">
        {% include 'accounting/vouchers/voucher_form_preview.html' %}
    </div>
</div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'libs/jquery.repeater/jquery.repeater.min.js' %}"></script>
<script>
// --- ENHANCED VOUCHER ENTRY JS ---

// 1. Add/Remove Lines (Component Structure)
function addJournalLine() {
    const tbody = document.querySelector('#journalLines tbody');
    const template = document.getElementById('journal-line-template');
    if (template && tbody) {
        const clone = template.content.cloneNode(true);
        tbody.appendChild(clone);
        updateLineNumbers();
        initializeAutocomplete();
        calculateTotals();
    }
}

function removeJournalLine(btn) {
    const row = btn.closest('tr');
    if (row) {
        row.remove();
        updateLineNumbers();
        calculateTotals();
    }
}

function updateLineNumbers() {
    document.querySelectorAll('#journalLines tbody tr').forEach((row, idx) => {
        const numCell = row.querySelector('.line-number');
        if (numCell) numCell.textContent = idx + 1;
    });
}

document.addEventListener('click', function(e) {
    if (e.target.matches('.btn-add-line')) {
        addJournalLine();
    }
    if (e.target.matches('.btn-remove-line')) {
        removeJournalLine(e.target);
    }
});

// 2. Inline Validation and Error Display
function validateField(field) {
    const isRequired = field.hasAttribute('required');
    const value = field.value.trim();
    field.classList.remove('is-invalid');
    let error = field.parentNode.querySelector('.validation-error');
    if (error) error.remove();
    if (isRequired && !value) {
        field.classList.add('is-invalid');
        const errDiv = document.createElement('div');
        errDiv.className = 'validation-error';
        errDiv.textContent = 'This field is required.';
        field.parentNode.appendChild(errDiv);
        return false;
    }
    return true;
}

document.addEventListener('blur', function(e) {
    if (e.target.matches('input, select, textarea')) {
        validateField(e.target);
    }
}, true);

document.getElementById('voucher-form').addEventListener('submit', function(e) {
    let valid = true;
    this.querySelectorAll('[required]').forEach(field => {
        if (!validateField(field)) valid = false;
    });
    if (!validateBalance()) valid = false;
    if (!valid) e.preventDefault();
});

// 3. Preview Modal Before Submission
function showPreview() {
    const modal = document.getElementById('voucher-preview-modal');
    if (modal) {
        // Fill modal with summary (implement as needed)
        modal.style.display = 'block';
    }
}
document.getElementById('submit-btn')?.addEventListener('click', function(e) {
    e.preventDefault();
    showPreview();
});
document.getElementById('edit-voucher')?.addEventListener('click', function() {
    document.getElementById('voucher-preview-modal').style.display = 'none';
});
document.getElementById('confirm-submit')?.addEventListener('click', function() {
    document.getElementById('voucher-form').submit();
});

// 4. Sticky Totals Bar & Calculation
function calculateTotals() {
    let debit = 0, credit = 0;
    document.querySelectorAll('input[name$="debit_amount"]').forEach(input => {
        debit += parseFloat(input.value) || 0;
    });
    document.querySelectorAll('input[name$="credit_amount"]').forEach(input => {
        credit += parseFloat(input.value) || 0;
    });
    document.getElementById('total-debit').textContent = debit.toFixed(2);
    document.getElementById('total-credit').textContent = credit.toFixed(2);
    document.getElementById('total-balance').textContent = (debit-credit).toFixed(2);
    validateBalance();
}

document.addEventListener('input', function(e) {
    if (e.target.matches('input[name$="debit_amount"], input[name$="credit_amount"]')) {
        calculateTotals();
    }
});

function validateBalance() {
    const debit = parseFloat(document.getElementById('total-debit').textContent) || 0;
    const credit = parseFloat(document.getElementById('total-credit').textContent) || 0;
    const balance = debit - credit;
    const balanceRow = document.querySelector('.total-row.balance');
    if (Math.abs(balance) > 0.01) {
        balanceRow.classList.add('text-danger');
        return false;
    } else {
        balanceRow.classList.remove('text-danger');
        return true;
    }
}

// 5. Autocomplete for Accounts, Departments, etc. (Placeholder)
function initializeAutocomplete() {
    // Example: Use a library or AJAX for account field autocomplete
    document.querySelectorAll('select[name$="account"]').forEach(select => {
        // Implement AJAX/autocomplete logic as needed
    });
}
document.addEventListener('DOMContentLoaded', initializeAutocomplete);

// 6. Permission-based UI (disable/hide actions as needed)
function applyPermissions(perms) {
    if (!perms.includes('accounting.journal_add')) {
        document.querySelectorAll('button[type="submit"]').forEach(btn => btn.disabled = true);
    }
}
// Pass permissions from Django context as a JS variable if needed
// Example:
// <script id="user-perms" type="application/json">{{ perms|json_script:"user-perms" }}</script>
// const userPerms = JSON.parse(document.getElementById('user-perms').textContent);
// applyPermissions(userPerms);

// 7. Initial calculations
calculateTotals();
</script>
{% endblock %} 