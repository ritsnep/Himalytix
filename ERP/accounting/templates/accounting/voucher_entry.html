{% extends 'accounting/_form_base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'libs/jquery.repeater/jquery.repeater.css' %}">
<style>
    .voucher-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-section h5 {
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .journal-line {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .journal-line:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }
    
    .line-number {
        position: absolute;
        top: -10px;
        left: 10px;
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .udf-field {
        margin-bottom: 1rem;
    }
    
    .udf-field label {
        font-weight: 600;
        color: #495057;
    }
    
    .udf-field .form-control {
        border-radius: 6px;
        border: 1px solid #ced4da;
    }
    
    .udf-field .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .totals-section {
        background: #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .total-row.balance {
        border-top: 2px solid #007bff;
        padding-top: 0.5rem;
        font-size: 1.1rem;
        color: #007bff;
    }
    
    .btn-add-line {
        background: #28a745;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        color: white;
        font-weight: 600;
    }
    
    .btn-add-line:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .btn-remove-line {
        background: #dc3545;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        color: white;
        font-size: 0.8rem;
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .btn-remove-line:hover {
        background: #c82333;
    }
    
    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .account-balance {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .account-balance.positive {
        color: #28a745;
    }
    
    .account-balance.negative {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="card">
                <div class="card-body">
                    <h1>Voucher Entry ({{ config.name }})</h1>
                    <form id="voucher-form" method="post" novalidate>
                        {% csrf_token %}
                        <h4>Header</h4>
                        {% for field in header_form %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        {# Render UDFs for header if present #}
                        {% if config.udf_configs.all %}
                            {% for udf in config.udf_configs.all %}
                                {% if udf.scope == 'header' %}
                                    <div class="mb-3">
                                        <label class="form-label">{{ udf.display_name }}</label>
                                        <input type="text" name="udf_{{ udf.field_name }}" class="form-control" {% if udf.is_required %}required{% endif %}>
                                        {% if udf.help_text %}
                                            <small class="form-text text-muted">{{ udf.help_text }}</small>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        <h4>Lines</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    {% for field in line_formset.empty_form %}
                                        <th>{{ field.label }}</th>
                                    {% endfor %}
                                    {# Render UDFs for lines if present #}
                                    {% if config.udf_configs.all %}
                                        {% for udf in config.udf_configs.all %}
                                            {% if udf.scope == 'line' %}
                                                <th>{{ udf.display_name }}</th>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    <th>Delete?</th>
                                </tr>
                            </thead>
                            <tbody id="journal-lines-body">
                                {% for form in line_formset.forms %}
                                    <tr>
                                        {% for field in form %}
                                            <td>
                                                {{ field }}
                                                {% for error in field.errors %}
                                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                        {% endfor %}
                                        {# Render UDFs for lines if present #}
                                        {% if config.udf_configs.all %}
                                            {% for udf in config.udf_configs.all %}
                                                {% if udf.scope == 'line' %}
                                                    <td>
                                                        <input type="text" name="udf_{{ udf.field_name }}_{{ forloop.counter0 }}" class="form-control" {% if udf.is_required %}required{% endif %}>
                                                    </td>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        <td>
                                            {% if form.can_delete %}
                                                {{ form.DELETE }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <button id="add-journal-line" type="button" class="btn btn-primary" {% if not user_perms.can_edit %}disabled{% endif %}>Add Line</button>
                        <button id="submit-btn" type="submit" class="btn btn-success" {% if not user_perms.can_edit %}disabled{% endif %}>Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'libs/jquery.repeater/jquery.repeater.min.js' %}"></script>
<script id="user-perms" type="application/json">{{ user_perms|json_script:"user-perms" }}</script>
<script>
// --- ENHANCED VOUCHER ENTRY JS ---

document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('add-journal-line');
    if (addBtn) {
        addBtn.addEventListener('click', addJournalLine);
    }
    const linesBody = document.getElementById('journal-lines-body');
    if (linesBody) {
        linesBody.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-remove-line')) {
                removeJournalLine(e.target);
            }
        });
    }
    initializeAutocomplete();
    calculateTotals();
    // Permissions
    const userPerms = JSON.parse(document.getElementById('user-perms').textContent);
    applyPermissions(userPerms);
});

function addJournalLine() {
    // You may want to use AJAX/HTMX to get a new line row if using dynamic forms
    // For now, just clone the last row
    const tbody = document.getElementById('journal-lines-body');
    if (!tbody) return;
    const lastRow = tbody.querySelector('tr:last-child');
    if (lastRow) {
        const clone = lastRow.cloneNode(true);
        // Clear input values
        clone.querySelectorAll('input, select, textarea').forEach(el => el.value = '');
        tbody.appendChild(clone);
        updateLineNumbers();
        initializeAutocomplete();
        calculateTotals();
    }
}

function removeJournalLine(btn) {
    const row = btn.closest('tr');
    if (row) {
        row.remove();
        updateLineNumbers();
        calculateTotals();
    }
}

function updateLineNumbers() {
    document.querySelectorAll('#journal-lines-body tr').forEach((row, idx) => {
        const numCell = row.querySelector('.line-number');
        if (numCell) numCell.textContent = idx + 1;
    });
}

function validateField(field) {
    if (!field) return true;
    const isRequired = field.hasAttribute('required');
    const value = field.value.trim();
    field.classList.remove('is-invalid');
    let error = field.parentNode.querySelector('.validation-error');
    if (error) error.remove();
    if (isRequired && !value) {
        field.classList.add('is-invalid');
        const errDiv = document.createElement('div');
        errDiv.className = 'validation-error';
        errDiv.textContent = 'This field is required.';
        field.parentNode.appendChild(errDiv);
        return false;
    }
    return true;
}

document.addEventListener('blur', function(e) {
    if (e.target.matches('input, select, textarea')) {
        validateField(e.target);
    }
}, true);

const voucherForm = document.getElementById('voucher-form');
if (voucherForm) {
    voucherForm.addEventListener('submit', function(e) {
        let valid = true;
        this.querySelectorAll('[required]').forEach(field => {
            if (!validateField(field)) valid = false;
        });
        if (!validateBalance()) valid = false;
        if (!valid) e.preventDefault();
    });
}

function calculateTotals() {
    let debit = 0, credit = 0;
    document.querySelectorAll('input[name$="debit_amount"]').forEach(input => {
        debit += parseFloat(input.value) || 0;
    });
    document.querySelectorAll('input[name$="credit_amount"]').forEach(input => {
        credit += parseFloat(input.value) || 0;
    });
    const totalDebit = document.getElementById('total-debit');
    const totalCredit = document.getElementById('total-credit');
    const totalBalance = document.getElementById('total-balance');
    if (totalDebit) totalDebit.textContent = debit.toFixed(2);
    if (totalCredit) totalCredit.textContent = credit.toFixed(2);
    if (totalBalance) totalBalance.textContent = (debit-credit).toFixed(2);
    validateBalance();
}

document.addEventListener('input', function(e) {
    if (e.target.matches('input[name$="debit_amount"], input[name$="credit_amount"]')) {
        calculateTotals();
    }
});

function validateBalance() {
    const debit = parseFloat(document.getElementById('total-debit')?.textContent) || 0;
    const credit = parseFloat(document.getElementById('total-credit')?.textContent) || 0;
    const balance = debit - credit;
    const balanceRow = document.querySelector('.total-row.balance');
    if (balanceRow) {
        if (Math.abs(balance) > 0.01) {
            balanceRow.classList.add('text-danger');
            return false;
        } else {
            balanceRow.classList.remove('text-danger');
            return true;
        }
    }
    return true;
}

function initializeAutocomplete() {
    // Example: Use a library or AJAX for account field autocomplete
    document.querySelectorAll('select[name$="account"]').forEach(select => {
        // Implement AJAX/autocomplete logic as needed
    });
}

function applyPermissions(perms) {
    if (!perms.can_edit) {
        document.querySelectorAll('button[type="submit"], #add-journal-line').forEach(btn => btn.disabled = true);
    }
}
</script>
{% endblock %} 